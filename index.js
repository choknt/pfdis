import 'dotenv/config';
import express from 'express';
import { Client, GatewayIntentBits, Partials, Routes, REST, ModalBuilder, TextInputBuilder, TextInputStyle, ActionRowBuilder, ButtonBuilder, ButtonStyle, EmbedBuilder, InteractionType } from 'discord.js';
import mongoose from 'mongoose';
import PlayFab from 'playfab-sdk';

// === CONFIG ===
const {
  DISCORD_TOKEN,
  DISCORD_CLIENT_ID,
  MONGO_URI,
  PLAYFAB_TITLE_ID,
  LOG_CHANNEL_ID,
  ADMIN_ROLE_ID,
  PORT = 3000
} = process.env;

// === MONGO MODEL ===
const playerSchema = new mongoose.Schema({
  discordId: String,
  discordName: String,
  playerId: String,
  playerName: String
});
const Player = mongoose.model('Player', playerSchema);

// === PLAYFAB INIT ===
PlayFab.settings.titleId = PLAYFAB_TITLE_ID;

// === DISCORD CLIENT ===
const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.DirectMessages,
    GatewayIntentBits.MessageContent
  ],
  partials: [Partials.Channel]
});

// === REGISTER COMMANDS ===
const commands = [
  { name: 'send-form', description: '‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô' },
  { name: 'show', description: '‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì' },
  { name: 'edit', description: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì' },
  {
    name: 'py-info',
    description: '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)',
    options: [{ name: 'playerid', type: 3, description: '‡πÑ‡∏≠‡∏î‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô', required: true }]
  },
  {
    name: 'admin-show',
    description: '‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)',
    options: [{ name: 'discordname', type: 3, description: '‡∏ä‡∏∑‡πà‡∏≠ Discord', required: true }]
  },
  {
    name: 'admin-edit',
    description: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)',
    options: [
      { name: 'discordname', type: 3, description: '‡∏ä‡∏∑‡πà‡∏≠ Discord', required: true },
      { name: 'playerid', type: 3, description: '‡πÑ‡∏≠‡∏î‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà', required: true }
    ]
  }
];

const rest = new REST({ version: '10' }).setToken(DISCORD_TOKEN);

// === EXPRESS HEALTH CHECK ===
const app = express();
app.get('/health', (req, res) => res.send('OK'));
app.listen(PORT, () => console.log(`HTTP health server on ${PORT}`));

// === HELPER: Get Player Info ===
function getPlayerName(playerId) {
  return new Promise((resolve, reject) => {
    PlayFab.PlayFabClient.GetAccountInfo({ PlayFabId: playerId }, (err, res) => {
      if (err || !res?.data) return reject(err || new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô'));
      resolve(res.data.AccountInfo.TitleInfo?.DisplayName || 'Unknown');
    });
  });
}

// === DISCORD EVENTS ===
client.once('ready', async () => {
  console.log(`ü§ñ Logged in as ${client.user.tag}`);

  // Register slash commands globally
  await rest.put(Routes.applicationCommands(DISCORD_CLIENT_ID), { body: commands });
  console.log('‚úÖ Slash commands registered');
});

client.on('interactionCreate', async (interaction) => {
  try {
    if (interaction.isChatInputCommand()) {
      if (interaction.commandName === 'send-form') {
        const btn = new ButtonBuilder()
          .setCustomId('verifyBtn')
          .setLabel('‡πÑ‡∏≠‡∏î‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì')
          .setStyle(ButtonStyle.Primary);
        const row = new ActionRowBuilder().addComponents(btn);

        const embed = new EmbedBuilder()
          .setTitle('‡πÇ‡∏õ‡∏£‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô')
          .setDescription('‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å ID ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì')
          .setColor('Blue')
          .setImage('https://i.imgur.com/xG74tFQ.png');

        await interaction.reply({ embeds: [embed], components: [row] });
      }

      if (interaction.commandName === 'show') {
        const data = await Player.findOne({ discordId: interaction.user.id });
        if (!data) return interaction.reply({ content: '‚ùå ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', ephemeral: true });

        const embed = new EmbedBuilder()
          .setTitle('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì')
          .addFields(
            { name: '‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°', value: data.playerId, inline: true },
            { name: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô', value: data.playerName, inline: true },
            { name: '‡∏ä‡∏∑‡πà‡∏≠ Discord', value: data.discordName, inline: true }
          )
          .setColor('Green');

        await interaction.reply({ embeds: [embed], ephemeral: true });
      }

      if (interaction.commandName === 'edit') {
        const modal = new ModalBuilder()
          .setCustomId('editModal')
          .setTitle('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°');
        const input = new TextInputBuilder()
          .setCustomId('newPlayerId')
          .setLabel('‡πÉ‡∏™‡πà‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà')
          .setStyle(TextInputStyle.Short)
          .setRequired(true);
        const row = new ActionRowBuilder().addComponents(input);
        modal.addComponents(row);
        await interaction.showModal(modal);
      }

      if (interaction.commandName === 'py-info') {
        if (!interaction.member.roles.cache.has(ADMIN_ROLE_ID))
          return interaction.reply({ content: '‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå', ephemeral: true });
        const pid = interaction.options.getString('playerid');
        try {
          const name = await getPlayerName(pid);
          const embed = new EmbedBuilder()
            .setTitle('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô')
            .addFields(
              { name: '‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°', value: pid },
              { name: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô', value: name }
            )
            .setColor('Blue');
          await interaction.reply({ embeds: [embed] });
        } catch {
          await interaction.reply({ content: `‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ${pid}`, ephemeral: true });
        }
      }

      if (interaction.commandName === 'admin-show') {
        if (!interaction.member.roles.cache.has(ADMIN_ROLE_ID))
          return interaction.reply({ content: '‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå', ephemeral: true });
        const dname = interaction.options.getString('discordname');
        const data = await Player.findOne({ discordName: dname });
        if (!data) return interaction.reply({ content: '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', ephemeral: true });

        const embed = new EmbedBuilder()
          .setTitle(`‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á ${dname}`)
          .addFields(
            { name: '‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°', value: data.playerId },
            { name: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô', value: data.playerName },
            { name: 'Discord', value: data.discordName }
          )
          .setColor('Blue');
        await interaction.reply({ embeds: [embed], ephemeral: true });
      }

      if (interaction.commandName === 'admin-edit') {
        if (!interaction.member.roles.cache.has(ADMIN_ROLE_ID))
          return interaction.reply({ content: '‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå', ephemeral: true });
        const dname = interaction.options.getString('discordname');
        const newId = interaction.options.getString('playerid');
        try {
          const name = await getPlayerName(newId);
          const data = await Player.findOneAndUpdate(
            { discordName: dname },
            { playerId: newId, playerName: name },
            { new: true }
          );
          if (!data) return interaction.reply({ content: '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', ephemeral: true });
          await interaction.reply({ content: `‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ${dname} ‡πÄ‡∏õ‡πá‡∏ô ${name} ‡πÅ‡∏•‡πâ‡∏ß`, ephemeral: true });
        } catch {
          await interaction.reply({ content: `‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ${newId}`, ephemeral: true });
        }
      }
    }

    if (interaction.isButton() && interaction.customId === 'verifyBtn') {
      const modal = new ModalBuilder().setCustomId('verifyModal').setTitle('‡πÇ‡∏õ‡∏£‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏≠‡∏î‡∏µ');
      const input = new TextInputBuilder()
        .setCustomId('playerIdInput')
        .setLabel('‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì')
        .setPlaceholder('‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 25CDF5286DC38DAD')
        .setStyle(TextInputStyle.Short)
        .setRequired(true);
      const row = new ActionRowBuilder().addComponents(input);
      modal.addComponents(row);
      await interaction.showModal(modal);
    }

    if (interaction.type === InteractionType.ModalSubmit) {
      if (interaction.customId === 'verifyModal') {
        const pid = interaction.fields.getTextInputValue('playerIdInput');
        try {
          const name = await getPlayerName(pid);

          const newPlayer = await Player.findOneAndUpdate(
            { discordId: interaction.user.id },
            { discordId: interaction.user.id, discordName: interaction.user.username, playerId: pid, playerName: name },
            { upsert: true, new: true }
          );

          // ‡∏™‡πà‡∏á log ‡πÑ‡∏õ‡∏´‡πâ‡∏≠‡∏á
          const logChannel = await client.channels.fetch(LOG_CHANNEL_ID);
          if (logChannel) {
            const embed = new EmbedBuilder()
              .setTitle('‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà')
              .addFields(
                { name: 'Discord', value: `${interaction.user.username} (${interaction.user.id})` },
                { name: '‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°', value: pid },
                { name: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô', value: name }
              )
              .setColor('Blue');
            logChannel.send({ embeds: [embed] });
          }

          // ‡∏™‡πà‡∏á DM
          const embed = new EmbedBuilder()
            .setTitle('‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß')
            .addFields(
              { name: '‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°', value: pid },
              { name: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô', value: name },
              { name: 'Discord', value: `${interaction.user.username} (${interaction.user.id})` }
            )
            .setColor('Green')
            .setTimestamp();
          await interaction.user.send({ embeds: [embed] });

          await interaction.reply({ content: '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö DM', ephemeral: true });
        } catch {
          const embed = new EmbedBuilder()
            .setTitle('‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô')
            .setDescription(`‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö **${pid}** ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà`)
            .setColor('Red')
            .setImage('https://i.imgur.com/xG74tFQ.png');
          await interaction.reply({ embeds: [embed], ephemeral: true });
        }
      }

      if (interaction.customId === 'editModal') {
        const newId = interaction.fields.getTextInputValue('newPlayerId');
        try {
          const name = await getPlayerName(newId);
          const data = await Player.findOneAndUpdate(
            { discordId: interaction.user.id },
            { playerId: newId, playerName: name },
            { new: true }
          );
          if (!data) return interaction.reply({ content: '‚ùå ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô', ephemeral: true });
          await interaction.reply({ content: `‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°‡πÄ‡∏õ‡πá‡∏ô ${name}`, ephemeral: true });
        } catch {
          await interaction.reply({ content: `‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ${newId}`, ephemeral: true });
        }
      }
    }
  } catch (err) {
    console.error(err);
  }
});

// === CONNECT DB & LOGIN ===
mongoose.connect(MONGO_URI).then(() => console.log('‚úÖ Mongo connected'));
PlayFab.PlayFabClient.LoginWithCustomID(
  { TitleId: PLAYFAB_TITLE_ID, CustomId: 'bot-' + Date.now(), CreateAccount: true },
  (err) => {
    if (err) console.error('PlayFab login failed', err);
    else console.log('‚úÖ PlayFab session ready');
  }
);

client.login(DISCORD_TOKEN);