import { Client, GatewayIntentBits, Partials, SlashCommandBuilder, Routes, REST, ActionRowBuilder, ButtonBuilder, ButtonStyle, ModalBuilder, TextInputBuilder, TextInputStyle, EmbedBuilder, InteractionType } from 'discord.js';
import mongoose from 'mongoose';
import dotenv from 'dotenv';
import express from 'express';
import PlayFab from 'playfab-sdk';

dotenv.config();

// ---------- CONFIG ----------
const {
  DISCORD_TOKEN,
  DISCORD_CLIENT_ID,
  DISCORD_GUILD_ID,
  MONGO_URI,
  PLAYFAB_TITLE_ID,
  LOG_CHANNEL_ID,
  ADMIN_ROLE_ID,
  FORM_IMAGE_URL
} = process.env;

// ---------- MONGODB ----------
const playerSchema = new mongoose.Schema({
  discordId: String,
  discordName: String,
  gameId: String,
  gameName: String
});
const Player = mongoose.model('Player', playerSchema);

// ---------- DISCORD CLIENT ----------
const client = new Client({
  intents: [GatewayIntentBits.Guilds, GatewayIntentBits.DirectMessages],
  partials: [Partials.Channel]
});

// ---------- PLAYFAB ----------
PlayFab.settings.titleId = PLAYFAB_TITLE_ID;

// helper: get gameName from PlayFabId
async function getGameNameById(playfabId) {
  return new Promise((resolve) => {
    PlayFab.Client.GetAccountInfo({ PlayFabId: playfabId }, (result, error) => {
      if (result && result.data && result.data.AccountInfo && result.data.AccountInfo.TitleInfo) {
        resolve(result.data.AccountInfo.TitleInfo.DisplayName || null);
      } else {
        resolve(null);
      }
    });
  });
}

// ---------- COMMANDS ----------
const commands = [
  new SlashCommandBuilder()
    .setName('send-form')
    .setDescription('‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô'),
  new SlashCommandBuilder()
    .setName('show')
    .setDescription('‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á'),
  new SlashCommandBuilder()
    .setName('edit')
    .setDescription('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á'),
  new SlashCommandBuilder()
    .setName('py-info')
    .setDescription('‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏≤‡∏Å PlayFab ID (admin)')
    .addStringOption(opt => opt.setName('id').setDescription('PlayFabId').setRequired(true)),
  new SlashCommandBuilder()
    .setName('admin-show')
    .setDescription('‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß (admin)')
    .addStringOption(opt => opt.setName('discord_name').setDescription('‡∏ä‡∏∑‡πà‡∏≠ Discord').setRequired(true)),
  new SlashCommandBuilder()
    .setName('admin-edit')
    .setDescription('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (admin)')
    .addStringOption(opt => opt.setName('discord_name').setDescription('‡∏ä‡∏∑‡πà‡∏≠ Discord').setRequired(true))
].map(cmd => cmd.toJSON());

// ---------- REGISTER COMMANDS ----------
const rest = new REST({ version: '10' }).setToken(DISCORD_TOKEN);
(async () => {
  try {
    console.log('Registering slash commands...');
    await rest.put(Routes.applicationGuildCommands(DISCORD_CLIENT_ID, DISCORD_GUILD_ID), { body: commands });
    console.log('Commands registered.');
  } catch (err) {
    console.error(err);
  }
})();

// ---------- EVENT HANDLERS ----------
client.on('ready', async () => {
  console.log(`ü§ñ Logged in as ${client.user.tag}`);
  await mongoose.connect(MONGO_URI);
  console.log('‚úÖ Mongo connected');
});

client.on('interactionCreate', async (interaction) => {
  if (interaction.isChatInputCommand()) {
    const { commandName } = interaction;

    if (commandName === 'send-form') {
      const embed = new EmbedBuilder()
        .setTitle('‡πÇ‡∏õ‡∏£‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô')
        .setDescription('‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å ID ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì')
        .setImage(FORM_IMAGE_URL || null)
        .setColor(0x00AE86);
      const row = new ActionRowBuilder().addComponents(
        new ButtonBuilder()
          .setCustomId('verify_button')
          .setLabel('‡πÑ‡∏≠‡∏î‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì')
          .setStyle(ButtonStyle.Primary)
      );
      await interaction.reply({ embeds: [embed], components: [row] });
    }

    if (commandName === 'show') {
      const data = await Player.findOne({ discordId: interaction.user.id });
      if (!data) return interaction.reply({ content: '‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô', ephemeral: true });
      const embed = new EmbedBuilder()
        .setTitle('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì')
        .addFields(
          { name: '‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°', value: data.gameId },
          { name: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô', value: data.gameName },
          { name: '‡πÑ‡∏≠‡∏î‡∏µ Discord', value: data.discordId },
          { name: '‡∏ä‡∏∑‡πà‡∏≠ Discord', value: data.discordName }
        )
        .setColor(0x00AE86);
      await interaction.reply({ embeds: [embed], ephemeral: true });
    }

    if (commandName === 'edit') {
      const modal = new ModalBuilder()
        .setCustomId('edit_modal')
        .setTitle('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì');
      const input = new TextInputBuilder()
        .setCustomId('edit_gameid')
        .setLabel('‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà')
        .setPlaceholder('‡πÄ‡∏ä‡πà‡∏ô 25CDF5286DC38DAD')
        .setStyle(TextInputStyle.Short)
        .setRequired(true);
      modal.addComponents(new ActionRowBuilder().addComponents(input));
      await interaction.showModal(modal);
    }

    if (commandName === 'py-info') {
      if (!interaction.member.roles.cache.has(ADMIN_ROLE_ID)) return interaction.reply({ content: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå', ephemeral: true });
      const id = interaction.options.getString('id');
      const name = await getGameNameById(id);
      await interaction.reply({ content: name ? `‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô: ${name}` : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' });
    }

    if (commandName === 'admin-show') {
      if (!interaction.member.roles.cache.has(ADMIN_ROLE_ID)) return interaction.reply({ content: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå', ephemeral: true });
      const discordName = interaction.options.getString('discord_name');
      const data = await Player.findOne({ discordName });
      if (!data) return interaction.reply({ content: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', ephemeral: true });
      const embed = new EmbedBuilder()
        .setTitle(`‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á ${discordName}`)
        .addFields(
          { name: '‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°', value: data.gameId },
          { name: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô', value: data.gameName },
          { name: '‡πÑ‡∏≠‡∏î‡∏µ Discord', value: data.discordId },
          { name: '‡∏ä‡∏∑‡πà‡∏≠ Discord', value: data.discordName }
        )
        .setColor(0x00AE86);
      await interaction.reply({ embeds: [embed], ephemeral: true });
    }

    if (commandName === 'admin-edit') {
      if (!interaction.member.roles.cache.has(ADMIN_ROLE_ID)) return interaction.reply({ content: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå', ephemeral: true });
      const discordName = interaction.options.getString('discord_name');
      const modal = new ModalBuilder()
        .setCustomId(`admin_edit_modal_${discordName}`)
        .setTitle(`‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°‡∏Ç‡∏≠‡∏á ${discordName}`);
      const input = new TextInputBuilder()
        .setCustomId('admin_edit_gameid')
        .setLabel('‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà')
        .setStyle(TextInputStyle.Short)
        .setRequired(true);
      modal.addComponents(new ActionRowBuilder().addComponents(input));
      await interaction.showModal(modal);
    }
  }

  // ---------- BUTTON ----------
  if (interaction.isButton()) {
    if (interaction.customId === 'verify_button') {
      const modal = new ModalBuilder()
        .setCustomId('verify_modal')
        .setTitle('‡πÇ‡∏õ‡∏£‡∏î‡∏õ‡πâ‡∏≠‡∏ô‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì');
      const input = new TextInputBuilder()
        .setCustomId('verify_gameid')
        .setLabel('‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°')
        .setPlaceholder('‡πÄ‡∏ä‡πà‡∏ô 25CDF5286DC38DAD')
        .setStyle(TextInputStyle.Short)
        .setRequired(true);
      modal.addComponents(new ActionRowBuilder().addComponents(input));
      await interaction.showModal(modal);
    }
  }

  // ---------- MODALS ----------
  if (interaction.type === InteractionType.ModalSubmit) {
    if (interaction.customId === 'verify_modal') {
      const gameId = interaction.fields.getTextInputValue('verify_gameid');
      const name = await getGameNameById(gameId);
      if (!name) {
        await interaction.user.send({ content: `‡πÑ‡∏°‡πà‡∏û‡∏ö ${gameId} ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á` });
        return interaction.reply({ content: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', ephemeral: true });
      }
      const data = await Player.findOneAndUpdate(
        { discordId: interaction.user.id },
        { discordId: interaction.user.id, discordName: interaction.user.username, gameId, gameName: name },
        { upsert: true, new: true }
      );
      const logChannel = await client.channels.fetch(LOG_CHANNEL_ID);
      if (logChannel) {
        const embed = new EmbedBuilder()
          .setTitle('‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÅ‡∏•‡πâ‡∏ß')
          .addFields(
            { name: '‡πÑ‡∏≠‡∏î‡∏µ Discord', value: data.discordId },
            { name: '‡∏ä‡∏∑‡πà‡∏≠ Discord', value: data.discordName },
            { name: '‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°', value: data.gameId },
            { name: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô', value: data.gameName }
          );
        logChannel.send({ embeds: [embed] });
      }
      await interaction.user.send({
        embeds: [
          new EmbedBuilder()
            .setTitle('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡πà‡∏≤‡∏ô')
            .addFields(
              { name: '‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏Å‡∏°', value: gameId },
              { name: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô', value: name },
              { name: '‡πÑ‡∏≠‡∏î‡∏µ Discord', value: interaction.user.id },
              { name: '‡∏ä‡∏∑‡πà‡∏≠ Discord', value: interaction.user.username }
            )
        ]
      });
      await interaction.reply({ content: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', ephemeral: true });
    }

    if (interaction.customId === 'edit_modal') {
      const gameId = interaction.fields.getTextInputValue('edit_gameid');
      const name = await getGameNameById(gameId);
      if (!name) return interaction.reply({ content: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', ephemeral: true });
      await Player.findOneAndUpdate(
        { discordId: interaction.user.id },
        { gameId, gameName: name }
      );
      await interaction.reply({ content: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', ephemeral: true });
    }

    if (interaction.customId.startsWith('admin_edit_modal_')) {
      const discordName = interaction.customId.replace('admin_edit_modal_', '');
      const gameId = interaction.fields.getTextInputValue('admin_edit_gameid');
      const name = await getGameNameById(gameId);
      if (!name) return interaction.reply({ content: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', ephemeral: true });
      await Player.findOneAndUpdate(
        { discordName },
        { gameId, gameName: name }
      );
      await interaction.reply({ content: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', ephemeral: true });
    }
  }
});

// ---------- EXPRESS HEALTH SERVER ----------
const app = express();
app.get('/health', (_req, res) => res.status(200).send('OK'));
app.listen(process.env.PORT || 3000, () => console.log('HTTP health server running'));

// ---------- LOGIN ----------
client.login(DISCORD_TOKEN);
